---
title: "Personal Consumption Expenditures by State"
author: "Jibei Zheng"
date: "11/18/2021"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

```{r setup, include = FALSE}
library(tidyverse)
library(readxl)
library(usmap)
library(plotly)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)
```

Load data

```{r, message = FALSE}
raw_df = 
  read_excel("data/pce_by_state.xlsx", sheet = "Table 1", range = "A4:F63", col_names = FALSE)

colnames(raw_df) = c("state", "2018", "2019", "2020", "2019_change", "2020_change")
```

Clean data

```{r}
pce_state_df = 
  raw_df %>% 
  filter(!(state %in% c("United States", "New England", "Mideast", "Great Lakes", "Plains", "Southeast", "Southwest", "Rocky Mountain", "Far West"))) %>% 
  mutate(
    code = c("CT", "ME", "MA", "NH", "RI", "VT", "DE", "DC", "MD", "NJ", "NY", "PA", "IL", "IN", "MI", "OH", "WI", "IA", "KS", "MN", "MO", "NE", "ND", "SD", "AL", "AR", "FL", "GA", "KY", "LA", "MS", "NC", "SC", "TN", "VA", "WV", "AZ", "NM", "OK", "TX", "CO", "ID", "MT", "UT", "WY", "AK", "CA", "HI", "NV", "OR", "WA")
  ) %>% 
  select(-"2019_change", -"2020_change") %>% 
  pivot_longer(
    "2018":"2020",
    names_to = "year",
    values_to = "pce"
  ) %>% 
  mutate(
    year = as.numeric(year),
  )
```

Draw map

```{r, warning = FALSE}
pce_state_20_df =
  pce_state_df %>% 
  filter(year == "2020")

g <- list(
  scope = 'usa',
  projection = list(type = 'albers usa'),
  showlakes = TRUE,
  lakecolor = toRGB('white')
)
fig <- plot_geo(pce_state_20_df, locationmode = 'USA-states')
fig <- fig %>% add_trace(
    z = ~pce, text = ~state, locations = ~code,
    color = ~pce, colorscale = list(c(0, 0.4, 1), c("#ecf6ff", "478fcc", "#004a88"))
  )
fig <- fig %>% colorbar(title = "PCE")
fig <- fig %>% layout(
    title = 'Per Capita Personal Consumption Expenditures by State, 2020)',
    geo = g
  )

fig
```

```{r, include = FALSE}
us = usmap::us_map()

us_val =
  us %>% 
  left_join(pce_state_20_df, by = c("full" = "state"))

us_centroids = 
  us_val %>% 
  group_by(full) %>% 
  summarise(centroid.x = mean(range(x)), 
            centroid.y = mean(range(y)),
            label = abbr,
            pce = pce)

state_plot =
  us_val %>% 
  ggplot() +
  geom_polygon(
    aes(x,y, group = group, fill = pce), 
    color = "black",
    size = .1
  ) +
  geom_text(
    data = us_centroids, 
    aes(centroid.x, centroid.y, label = paste(label, "\n", pce)),
    size = 2
  ) +
  scale_fill_gradient2(low = "white", mid = "skyblue2", high = "skyblue4", midpoint = 800000) +
  labs(
    title = "Per Capita Personal Consumption Expenditures by State, 2020",
    x = "",
    y = ""
  ) +
  theme_void()

ggplotly(state_plot)
```

