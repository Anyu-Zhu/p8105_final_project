---
title: "Exploratory Analysis of Covid-19 Data"
output: 
  html_document:
      toc: true
      toc_float: true
      code_folding: hide
---

## Introduction

January 17, 2020 CDC begins screening passengers on direct and connecting flights from Wuhan, China at San Francisco, California, New York City, New York, and Los Angeles, California and plans to expand screening to other major airports. January 20, 2020 CDC confirms the first U.S. laboratory-confirmed case of COVID-19 in the U.S. from samples taken on January 18 in Washington state.

```{r, echo=FALSE, message=FALSE}
library(tidyverse)
library(naniar)
library(plotly)
library(rvest)
library(ggplot2)
library(lubridate)

knitr::opts_chunk$set(
  fig.width = 8,
  fig.asp = .8,
  out.width = "90%"
)
```

## Trends in Number of Cases

```{r, message=FALSE, warning=FALSE}
covid_cum = read_csv("data/covid_cumulative_cases.csv", skip = 2) %>% 
  janitor::clean_names()

covid_day = read_csv("data/covid_daily_cases.csv", skip = 2) %>% 
  janitor::clean_names()

covid_daily = left_join(covid_day, covid_cum, by = "date") %>% 
  select(date, new_cases, total_cases) %>% 
  separate(date, into = c("month","day","year")) %>% 
  mutate(month = factor(month, levels = month.abb)) %>% 
  group_by(year, month) %>% 
  arrange(year, month, day) %>% 
  mutate(date = make_date(year, month, day)) %>% 
  arrange(date)
  
covid_monthly = covid_daily %>% 
  select(-day) %>% 
  summarize(monthly = sum(new_cases))

covid_seasonal = covid_monthly %>% 
  mutate(quarter = recode(month,
    "Jan" = "q1",
    "Feb" = "q1",
    "Mar" = "q1",
    "Apr" = "q2",
    "May" = "q2",
    "Jun" = "q2",
    "Jul" = "q3",
    "Aug" = "q3",
    "Sep" = "q3",
    "Oct" = "q4",
    "Nov" = "q4",
    "Dec" = "q4"
  )) %>% 
  group_by(year, quarter) %>% 
  summarize(quarterly = sum(monthly)) %>% 
  mutate(date = str_c(year, quarter, sep = "_"))

write_csv(covid_seasonal, 'covid_seasonal.csv')

row_cum = nrow(covid_cum)
row_daily = nrow(covid_daily)
daily_fig = plot_ly(covid_daily) 

daily_fig %>% 
  add_trace(x = ~date, y = ~new_cases, type = "bar", yaxis="y", name = "new", marker = list(color = 'rgb(158,202,225)')) %>% 
  add_trace(x = ~date, y = ~total_cases, type = "scatter", mode = "lines", yaxis = "y2", name = "cumulative") %>% 
  layout(yaxis=list(title = "daily new cases", side="left"),
         yaxis2=list(title = "cumulative cases", side="right",overlaying="y"),
         showlegend=TRUE)
```

## Map of Cases

### The latest Case Rate Per 100k

CDC COVID Data Tracker provides the covid cases data by state with total time period since the first covid case comfirmed till Thu Nov 18 2021.

```{r, message=FALSE, warning=FALSE}
# input data table for Total Cases by State/Territory
covid_total_by_state = 
  read_csv("./data/united_states_covid19_cases_deaths_and_testing_by_state.csv", skip = 2) %>% 
  janitor::clean_names()

# figure out the missing data in data frame
na_strings = "N/A"

# fill in missing data
covid_total_by_state_tidy =
  covid_total_by_state %>% 
  replace_with_na_all(condition = ~.x %in% na_strings) %>% 
  mutate(
    state_territory = as.factor(state_territory),
    case_rate_per_100000 = as.numeric(case_rate_per_100000)
         ) %>% 
  rename(region = "state_territory") %>% 
  select(region, case_rate_per_100000) %>% 
  mutate(region = recode(region, "New York*" = "New York"))

#Let's make a choropleth map plot to show the total covid cases by state in US.
#Load the usa postal code dataset.
postal_code = 
  read_csv("./data/us_postal_code.csv") %>% 
  janitor::clean_names()

# join the data frames
plot_df = 
  left_join(postal_code, covid_total_by_state_tidy, by = c("state" = "region")) %>% 
  relocate(code)

# specify some map projection/options
g = list(
  scope = 'usa',
  projection = list(type = 'albers usa'),
  showlakes = TRUE,
  lakecolor = toRGB('white')
)

plot_df$hover = with(plot_df, paste(
  state, '<br>')
  )

# make the plot
map_plotly1 = 
  plot_geo(plot_df, locationmode = 'USA-states') %>% 
  add_trace(
    z = ~case_rate_per_100000, 
    text = ~hover, 
    locations = ~code,
    color = ~case_rate_per_100000, 
    colorscale = list(c(0, 0.6, 1), c("#ffffff", "#83c5fd", "#0066FF"))
  ) %>% 
  colorbar(title = "Case Rate Per 100K") %>% 
  layout(
    title = "COVID-19 Case Rate by State/Territory (cases per 100,000)",
    geo = g
  )
```

This map shows the number of cases since the pandemic started for every 100,000 people, allowing you to compare areas with different population sizes.
[The data generated: Thu Nov 18 2021 22:02:06 GMT-0500 (EST)]

`r map_plotly1`

The five regions with the highest incidence of new crowns are North Dakota, Alaska, Tennessee, Wyoming and South Dakota.

### Total Case Rate Per 100k in 2020

The following map shows the covid case rate per 100k in year 2020.  [The data generated: Dec.31.2020]

```{r, message=FALSE, warning=FALSE}
# read data function
read_data_function = function(file_df) {
  
  state_df = 
    read_csv(file_df, skip = 2)
  
  return(state_df)
}

# create a data frame containing all participants
state_2020 =
  tibble(
    files = list.files("./data/state_covid_separate")
  ) %>% 
  mutate(
    path = map(.x = files, ~paste("./data/state_covid_separate", ., sep = "/"))
  ) %>%                                                             # add path
  mutate(
    observations = map(path, read_data_function))

#Let's unnest the data frame and filter the cases on Dec.31.2020
state_2020_tidy =
  state_2020 %>% 
  unnest(cols = "observations") %>% 
  janitor::clean_names() %>% 
  filter(date == "Dec 31 2020") %>%
  select(state, total_cases, total_case_rate_per_100k)

plot_2020_df = left_join(state_2020_tidy, postal_code, by = "state")

# specify some map projection/options
g = list(
  scope = 'usa',
  projection = list(type = 'albers usa'),
  showlakes = TRUE,
  lakecolor = toRGB('white')
)

plot_2020_df$hover = with(plot_2020_df, paste(
  state, '<br>', "Total case", total_cases, "<br>")
  )
#Make map plot.
map_plotly2 = 
  plot_geo(plot_2020_df, locationmode = 'USA-states') %>% 
  add_trace(
    z = ~total_case_rate_per_100k, 
    text = ~hover, 
    locations = ~code,
    color = ~total_case_rate_per_100k, 
    colorscale = list(c(0, 0.6, 1), c("#ffffff", "#83c5fd", "#0066FF"))
  ) %>% 
  colorbar(title = "Case Rate Per 100K") %>% 
  layout(
    title = "2020 COVID-19 Case Rate by State/Territory (cases per 100,000)",
    geo = g
  )
```

`r map_plotly2`

The five regions with the highest incidence of new crowns are North Dakota, South Dakota, Wisconsin, Iowa and Nebraska.