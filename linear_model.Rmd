---
title: "Regression Model for Comsumption Prediction"
author: "Shihui Zhu"
output: 
  html_document:
    toc: true
    toc_float: true
---

Personal income decreased \$216.2 billion, or 1.0 percent at a monthly rate, while consumer spending increased \$93.4 billion, or 0.6 percent, in September. The decrease in personal income primarily reflected the winding down of pandemic-related assistance programs. 

TO DOs:
* linear model: consumption ~ time, COVID-19

```{r setup, include=FALSE}
# Reproducibility
set.seed(1)

# This chunk loads all the packages used in this homework
library(tidyverse)
library(viridis)
library(ggridges)
library(patchwork)

library(plotly)
library(rvest)
library(ggplot2)
library(lubridate)
library(readxl)

library(modelr)
library(mgcv)

# General figure set up
knitr::opts_chunk$set(
  # display the code in github doc
  echo = TRUE,
  # hide warning messages
  warning = FALSE,
  message = FALSE,
  # set the figure to be 8 x 6, and the proportion it takes to be 95%
  fig.width = 10,
  fig.height = 8, 
  out.width = "90%"
)

# setting a global options for continuous data color family and a different format to set discrete data to have a color family
options(
  ggplot2.countinuous.colour = "viridis",
  ggplot2.countinuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

# have a minimal theme and legends at the bottom
theme_set(theme_minimal() + theme(legend.position = "bottom"))
```

## Data tidying

We are insterested in exploring the how the changes in the following variables in personal income might affect PCE:

* Wages and salaries
* Supplements to wages and salaries
* Social Security
* Medicare
* Personal Current Taxes

v.s.
* Personal consumption expenditures (on goods and services)

We want to look at data from 1967Q1 to 2020Q4

```{r split_label}
format_function <- function(input) {
  str_c(str_split(input, 'q')[[1]][1], ' Quarter ', str_split(input, 'q')[[1]][2])
}
```


```{r load, message=FALSE}
pce_4720 <- read_excel("data/pce_1947_2020.xlsx", sheet = 'T20100-Q', 
                      range = 'A8:KM54') %>% 
  janitor::clean_names() %>%
  select(x2, x1967q1:x2020q4) %>%
  drop_na() %>%
  # We only want to look at several variables:
  filter(
      x2 == 'Wages and salaries' |
      x2 == 'Supplements to wages and salaries' |
      x2 == 'Social security' |
      x2 == 'Medicare' |
      x2 == 'Less: Personal current taxes' |
      x2 == 'Personal consumption expenditures'
  ) %>%
  pivot_longer(
    x1967q1:x2020q4,
    names_to = 'time',
    names_prefix = 'x',
    values_to = 'millions_of_dollars'
  ) %>%
  rename(variable = x2) %>%
  mutate(
    variable = ifelse(variable == 'Less: Personal current taxes', 'Personal current taxes', variable)
  )
  #separate(time, c("year", "quarter"), "q") %>%
  
pce_4720_formatted <- pce_4720 %>%
  mutate(
    time = map(.x = time, format_function)
  )
```

## Overview 

Let's take a brief look at the changes of variables over time
```{r}
fig_1 <- pce_4720_formatted %>%
  plot_ly(x = ~time, y = ~millions_of_dollars, type = "scatter", mode = "lines", color = ~variable) %>%
  layout(title = "<b> Spaghetti Plot for Personal Income and Dispositions v.s. PCE <b>", yaixs = list(title = "<i> Millions of Dollars <i>"), barmode = "stack", legend = list(title = list(text = '<b> Dispositions </b>'))) %>% 
  layout(legend = list(orientation = 'h', x = 0, y = -0.2))

fig_1
```

A log graph will be more informative

```{r log}
fig_2 <- pce_4720_formatted %>%
  plot_ly(x = ~time, y = ~log(millions_of_dollars), type = "scatter", mode = "lines", color = ~variable) %>%
  layout(title = "<b> Spaghetti Plot for log(Personal Income and Dispositions) v.s. PCE </b>", yaixs = list(title = "log(Millions of Dollars)"), barmode = "stack", legend = list(title = list(text = '<i> Dispositions </i>'))) %>% 
  layout(legend = list(orientation = 'h', x = 0, y = -0.2))

fig_2
```


## Model

Now let's look at data pre- v.s. post-COVID-19 Pandemic

### Fit a multivariable model based on pre-COVID-19 Pandemic
```{r model}
pce_4718_by_dis <-
  pce_4720 %>%
  filter(!str_detect(time, '2019|2020')) %>%
  pivot_wider(
    names_from = variable,
    values_from = millions_of_dollars
  ) %>%
  janitor::clean_names()
  

smooth_mod = mgcv::gam(
  log(personal_consumption_expenditures) ~ s(log(wages_and_salaries)) + 
    s(log(social_security)) + s(log(supplements_to_wages_and_salaries)) + s(log(personal_current_taxes)) + s(log(medicare)), 
  data = pce_4718_by_dis)

summary(smooth_mod)
```

## Model Evaluation

```{r}
smooth_mod %>% broom::tidy()
smooth_mod.fit <- mgcViz::getViz(smooth_mod)
qqplot <- mgcViz::qq(smooth_mod.fit, method = "simul1", a.qqpoi = list("shape" = 1), a.ablin = list("linetype" = 2))
qqplot
```

Now let's predict the PCE using our model

```{r, collapse=TRUE}
pce_2019 <-
  pce_4720 %>%
  filter(
    str_detect(time, '2019')
  ) %>%
  pivot_wider(
    names_from = variable,
    values_from = millions_of_dollars
  ) %>%
  janitor::clean_names()
  
pce_2019_pred <- predict.gam(smooth_mod,pce_2019)
pce_2019_pred
log(pce_2019$personal_consumption_expenditures)

#RMSQ
rmse(smooth_mod, pce_2019)
```

```{r, collapse=TRUE}
pce_2020 <-
  pce_4720 %>%
  filter(
    str_detect(time, '2020')
  ) %>%
  pivot_wider(
    names_from = variable,
    values_from = millions_of_dollars
  ) %>%
  janitor::clean_names()
  
pce_2020_pred <- predict.gam(smooth_mod,pce_2020)
pce_2020_pred
log(pce_2020$personal_consumption_expenditures)

#RMSQ
rmse(smooth_mod, pce_2020)
```

## Testing on the difference

**Hypothesize: there is significant difference between our model prediction for year 2019 and year 2020**

```{r}
# Bootstrapping? Testing on 1967-2016
# include dataset from 2021q1, 2021q2, 2021q3
# 
```

